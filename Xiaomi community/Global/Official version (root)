#!/system/bin/sh
# ============================================================
# å°ç±³ç¤¾å€è‡ªå‹•ç°½åˆ° - Root Termux æ­£å¼ç‰ˆ
#
# ã€ç”¨é€”ã€‘
# - å®Œå…¨è‡ªå‹•åŒ–ï¼Œæ¯å¤© 00:00 ç°½åˆ°
# - åªéœ€å•Ÿå‹•ä¸€æ¬¡ï¼Œä¹‹å¾Œäº¤çµ¦ cron å®šæ™‚åŸ·è¡Œ
#
# ã€åŠŸèƒ½æ¸…å–®ã€‘
# 1. ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ â†’ è‡ªå‹•å®‰è£ cron ä»»å‹™
#    - æ¯å¤© 23:59 è‡ªå‹•åŸ·è¡Œæ­¤è…³æœ¬
# 2. æ¯å¤©ç°½åˆ°æµç¨‹ï¼š
#    - 23:59:35 æå‰æ‰“é–‹ Appï¼Œç¢ºä¿è¼‰å…¥å®Œæˆ
#    - ç­‰åˆ° 00:00:00 è‡ªå‹•é»æ“Šç°½åˆ°
#    - 00:00:01 å†è£œé»ä¸€æ¬¡ï¼Œé¿å…å»¶é²
# 3. è¢å¹•ç‹€æ…‹åˆ¤æ–·
#    - å¦‚æœè¢å¹•é—œé–‰ â†’ è‡ªå‹•å–šé†’ & èª¿æ•´äº®åº¦ = 20
#    - å¦‚æœè¢å¹•å·²é–‹ â†’ ç¶­æŒç¾ç‹€
# 4. è¢å¹•äº®åº¦æ§åˆ¶
#    - èª¿æ•´åˆ°æœ€ä½äº®åº¦ (20) ä»¥ç¯€èƒ½
# 5. é˜²æ­¢ä¼‘çœ  (Doze)
#    - åœ¨ç°½åˆ°éç¨‹ä¸­ä¿æŒ CPU é†’è‘—
# 6. ç°½åˆ°æµç¨‹
#    - è‡ªå‹•è™•ç†ã€ŒNo Thanksã€å½ˆçª—
#    - é»æ“Šå…©å€‹æŒ‰éˆ•é€²å…¥ç°½åˆ°é 
#    - æº–é»åˆå¤œè‡ªå‹•é»æ“Šç°½åˆ°
#    - åˆ¤æ–·ç°½åˆ°æ˜¯å¦æˆåŠŸ (æ©˜è‰² UNLOCK æŒ‰éˆ•æ˜¯å¦æ¶ˆå¤±)
#    - ç™¼é€ Android é€šçŸ¥é¡¯ç¤ºçµæœ
# 7. æ”¶å°¾è™•ç†
#    - ç­‰å¾… 30 ç§’
#    - å¦‚æœè¢å¹•æ˜¯è…³æœ¬å¹«å¿™é–‹çš„ â†’ è‡ªå‹•é—œé–‰
#    - å¦‚æœåŸæœ¬æ˜¯äº®å± â†’ ä¿æŒäº®å±
# ============================================================

PKG="com.mi.global.bbs"
LOGFILE="/data/local/tmp/signin_log.txt"
SCRIPT_PATH="/data/local/tmp/signin.sh"

SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}
HEIGHT=${SIZE#*x}
SCREEN_OPENED_BY_SCRIPT=0

log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $MSG" | tee -a $LOGFILE
}

tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

notify() {
  MSG="$1"
  cmd notification post -S bigtext -t "å°ç±³ç°½åˆ°" "signin_result" "$MSG"
}

is_screen_on() {
  dumpsys power | grep -q "Display Power: state=ON"
}

turn_on_screen() {
  input keyevent KEYCODE_WAKEUP
  settings put system screen_brightness 20
  log "ğŸ’¡ è¢å¹•å·²é–‹å•Ÿ (äº®åº¦=20)"
}

turn_off_screen() {
  input keyevent KEYCODE_SLEEP
  log "ğŸŒ™ è¢å¹•å·²é—œé–‰"
}

install_cron() {
  CRON_JOB="59 23 * * * tsu -c 'sh $SCRIPT_PATH'"
  crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"
  if [ $? -ne 0 ]; then
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "ğŸ•’ å·²å°‡è…³æœ¬åŠ å…¥ cron (æ¯å¤© 23:59 è‡ªå‹•åŸ·è¡Œ)"
  fi
}

pkg install -y cronie >/dev/null 2>&1
sv-enable crond >/dev/null 2>&1
install_cron

# ---------------- ä¸»æµç¨‹ ----------------
log "â–¶ï¸ æ­£å¼ç‰ˆç°½åˆ°æµç¨‹å•Ÿå‹•"

while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "23:59:35" ]; then
    break
  fi
  sleep 0.5
done

if is_screen_on; then
  log "ğŸ“± è¢å¹•å·²äº® â†’ ä¿æŒç¾ç‹€"
else
  log "ğŸ“± è¢å¹•é—œé–‰ â†’ å¹«ä½ æ‰“é–‹"
  turn_on_screen
  SCREEN_OPENED_BY_SCRIPT=1
fi

am force-stop $PKG
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5
log "ğŸ“² App å·²å•Ÿå‹•"

if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "ğŸ‘‰ å·²é»æ“Š 'No Thanks'"
  sleep 1
fi

tap_percent 77.9 95.8
log "âœ… é»æ“Šé¦–é åº•éƒ¨æŒ‰éˆ• (BTN_1)"
sleep 1

tap_percent 43.1 79.6
log "âœ… é»æ“Šç°½åˆ°å…¥å£ (BTN_2)"
sleep 2

while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:00" ]; then
    break
  fi
  sleep 0.1
done

for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "ğŸ¯ å·²å®Œæˆ 5 æ¬¡ç°½åˆ°é»æ“Š"

sleep 1
tap_percent 52.4 92.7
log "ğŸ¯ 00:00:01 è£œé» 1 æ¬¡"

if check_text "UNLOCK"; then
  log "âŒ ç°½åˆ°å¤±æ•— (UNLOCK æŒ‰éˆ•ä»å­˜åœ¨)"
  notify "âŒ ç°½åˆ°å¤±æ•—"
else
  log "âœ… ç°½åˆ°æˆåŠŸ (UNLOCK æŒ‰éˆ•æ¶ˆå¤±)"
  notify "âœ… ç°½åˆ°æˆåŠŸ"
fi

if [ $SCREEN_OPENED_BY_SCRIPT -eq 1 ]; then
  log "âŒ› ç­‰å¾… 30 ç§’å¾Œè‡ªå‹•é—œè¢å¹•"
  sleep 30
  turn_off_screen
else
  log "ğŸ”† è¢å¹•åŸæœ¬æ˜¯äº®çš„ â†’ ä¸é—œé–‰"
fi

log "ğŸ æ­£å¼ç‰ˆç°½åˆ°æµç¨‹å®Œæˆ"
