#!/system/bin/sh
# ============================================================
# 小米社區自動簽到 - 正式版
# 功能：
#   1. 每天 23:59:35 啟動 → 等待到 00:00:00 自動簽到
#   2. 點擊簽到按鈕（使用螢幕百分比座標）
#   3. 成功 / 失敗 判斷（簽到按鈕消失 or 顯示成功）
#   4. 完整日誌（詳細紀錄） + 簡易日誌（每天一行）
#   5. 成功 / 失敗 通知提醒
#   6. 支援自動排程（cron）
# ============================================================

PKG="com.mi.global.bbs"                          # 小米社區 App 套件名
LOGFILE="/sdcard/signin_log.txt"                 # 完整日誌檔案
SIMPLE_LOG="/sdcard/signin_simple.txt"           # 簡易日誌檔案（每天一行）

# 📝 日誌函式（寫入完整日誌）
log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] (正式版) $MSG" | tee -a $LOGFILE
}

# 🔔 通知函式（發送系統 toast 提醒）
notify() {
  MSG="$1"
  am broadcast -a com.android.systemui.toast \
    --es toast_text "$MSG" >/dev/null 2>&1
}

# 📌 Tap 點擊（使用螢幕百分比換算座標）
SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}                                 # 螢幕寬度
HEIGHT=${SIZE#*x}                                # 螢幕高度
tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

# 🔍 判斷畫面文字（用於判斷成功 / 失敗）
check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

# ============================================================
# 🕛 等待到 23:59:35（比 00:00 提前 25 秒）
# ============================================================
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "23:59:35" ]; then
    break
  fi
  sleep 0.5
done
log "▶️ (正式版) 自動簽到流程啟動"

# ============================================================
# 📱 打開 App
# ============================================================
am force-stop $PKG                               # 關閉 App
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5                                          # 等待 App 開啟完成
log "📱 打開 App 完成"

# ============================================================
# ⛔ 如果有 "No Thanks" 彈窗就點掉
# ============================================================
if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "👉 點擊 'No Thanks'"
  sleep 1
fi

# ============================================================
# 🛠️ 進入簽到頁面（BTN_1 → BTN_2 → UNLOCK）
# ============================================================
tap_percent 77.9 95.8
log "✅ 點擊 BTN_1"
sleep 1

tap_percent 43.1 79.6
log "✅ 點擊 BTN_2 → 已停在 UNLOCK 前"

# ============================================================
# 🕛 等到 00:00:00 再狂點 UNLOCK
# ============================================================
log "🕛 等待 00:00:00"
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:00" ]; then
    break
  fi
  sleep 0.1
done

for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "🎯 (正式版) 00:00:00 已完成 5 次簽到點擊"

# 00:00:01 再補點一次
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:01" ]; then
    tap_percent 52.4 92.7
    log "🛡️ (正式版) 00:00:01 補點 1 次"
    break
  fi
  sleep 0.1
done

# ============================================================
# 🎯 成功 / 失敗 判斷
#   - 成功：UNLOCK 按鈕消失 / 顯示「簽到成功」 / 顯示「已簽到」
#   - 失敗：UNLOCK 還存在
# ============================================================
sleep 2   # 等畫面更新
if ! check_text "UNLOCK" || check_text "簽到成功" || check_text "已簽到"; then
  RESULT="✅ 成功"
else
  RESULT="❌ 失敗"
fi

# 📌 最終紀錄
log "🏁 (正式版) 簽到流程完成 → $RESULT"
echo "$(date '+%Y-%m-%d') $RESULT" >> $SIMPLE_LOG
notify "小米簽到：$RESULT"
