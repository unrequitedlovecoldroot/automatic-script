#!/system/bin/sh
# ============================================================
# å°ç±³ç¤¾å€è‡ªå‹•ç°½åˆ° - æ­£å¼ç‰ˆ (Root + Termux + cron + åŽŸç”Ÿé€šçŸ¥)
# åŠŸèƒ½ï¼š
#   1. æ¯å¤© 23:59:35 å•Ÿå‹•ï¼Œ00:00:00 æº–æ™‚ç°½åˆ°
#   2. ä½¿ç”¨ç™¾åˆ†æ¯”é»žæ“Šï¼Œé¿å…ä¸åŒè§£æžåº¦å¤±æ•—
#   3. æˆåŠŸåˆ¤æ–·ï¼šç°½åˆ°å¾Œ UNLOCK æŒ‰éˆ•æ¶ˆå¤±
#   4. æ—¥èªŒï¼šå®Œæ•´æ—¥èªŒ + ç°¡æ½”æ—¥èªŒ
#   5. Android åŽŸç”Ÿé€šçŸ¥ (ä¸ç”¨ Termux:API)
#   6. è‡ªå‹•åŠ å…¥ cron æŽ’ç¨‹
# ============================================================

PKG="com.mi.global.bbs"
LOGFILE="/data/local/tmp/signin_log.txt"
SIMPLE_LOG="/data/local/tmp/signin_simple.txt"
CRON_JOB="59 23 * * * su -c /data/local/tmp/signin.sh"

# ðŸ“ æ—¥èªŒè¼¸å‡º
log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] (æ­£å¼ç‰ˆ) $MSG" | tee -a $LOGFILE
}

# ðŸ”” Android åŽŸç”Ÿé€šçŸ¥
notify() {
  MSG="$1"
  cmd notification post -S bigtext -t "å°ç±³ç°½åˆ°" "signin_result" "$MSG"
}

# ðŸ“Œ Tap é»žæ“Šï¼ˆç™¾åˆ†æ¯”æ›ç®—ï¼‰
SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}
HEIGHT=${SIZE#*x}
tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

# ðŸ” åˆ¤æ–·ç•«é¢æ–‡å­—
check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

# ============================================================
# ðŸ› ï¸ è‡ªå‹•æŽ’ç¨‹è¨­å®š
# ============================================================
setup_cron() {
  if ! command -v crond >/dev/null 2>&1; then
    log "âš ï¸ å°šæœªå®‰è£ cronieï¼Œè«‹å…ˆåŸ·è¡Œï¼špkg install cronie"
    return
  fi

  sv-enable crond >/dev/null 2>&1 || log "â„¹ï¸ è«‹ç¢ºä¿ crond å·²å•Ÿå‹•"

  crontab -l 2>/dev/null | grep -q "signin.sh"
  if [ $? -ne 0 ]; then
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "âœ… å·²åŠ å…¥è‡ªå‹•æŽ’ç¨‹ï¼šæ¯å¤© 23:59 åŸ·è¡Œ"
  else
    log "â„¹ï¸ æŽ’ç¨‹å·²å­˜åœ¨ï¼Œè·³éŽæ–°å¢ž"
  fi
}

# ============================================================
# ðŸ•› ä¸»æµç¨‹
# ============================================================
setup_cron

# ç­‰å¾… 23:59:35
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "23:59:35" ]; then
    break
  fi
  sleep 0.5
done
log "â–¶ï¸ (æ­£å¼ç‰ˆ) ç°½åˆ°æµç¨‹å•Ÿå‹•"

# æ‰“é–‹ App
am force-stop $PKG
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5
log "ðŸ“± æ‰“é–‹ App å®Œæˆ"

# è™•ç†å½ˆçª—
if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "ðŸ‘‰ é»žæ“Š 'No Thanks'"
  sleep 1
fi

# é€²å…¥ç°½åˆ°é 
tap_percent 77.9 95.8
log "âœ… é»žæ“Š BTN_1"
sleep 1

tap_percent 43.1 79.6
log "âœ… é»žæ“Š BTN_2 â†’ å·²åœåœ¨ UNLOCK å‰"

# ç­‰åˆ° 00:00:00 ç‹‚é»ž
log "ðŸ•› ç­‰å¾… 00:00:00"
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:00" ]; then
    break
  fi
  sleep 0.1
done

for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "ðŸŽ¯ (æ­£å¼ç‰ˆ) å·²å®Œæˆ 5 æ¬¡é»žæ“Š"

# 00:00:01 è£œé»žä¸€æ¬¡
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:01" ]; then
    tap_percent 52.4 92.7
    log "ðŸ›¡ï¸ (æ­£å¼ç‰ˆ) è£œé»ž 1 æ¬¡"
    break
  fi
  sleep 0.1
done

# âœ… åˆ¤æ–·æ˜¯å¦æˆåŠŸï¼ˆä¾æ“šï¼šUNLOCK æŒ‰éˆ•æ¶ˆå¤±ï¼‰
sleep 2
if ! check_text "UNLOCK"; then
  RESULT="âœ… æˆåŠŸ"
else
  RESULT="âŒ å¤±æ•—ï¼ˆæ©˜è‰²æŒ‰éˆ•ä»å­˜åœ¨ï¼‰"
fi

log "ðŸ (æ­£å¼ç‰ˆ) ç°½åˆ°å®Œæˆ â†’ $RESULT"
echo "$(date '+%Y-%m-%d') $RESULT" >> $SIMPLE_LOG
notify "$RESULT"
