#!/system/bin/sh
# ============================================================
# å°ç±³ç¤¾å€è‡ªå‹•ç°½åˆ° - æ¸¬è©¦ç‰ˆ (Root + Termux + åŽŸç”Ÿé€šçŸ¥)
# åŠŸèƒ½ï¼š
#   1. æ‰‹å‹•åŸ·è¡Œï¼Œç«‹å³æ¸¬è©¦ç°½åˆ°
#   2. ä½¿ç”¨ç™¾åˆ†æ¯”é»žæ“Š
#   3. æˆåŠŸåˆ¤æ–·ï¼šç°½åˆ°å¾Œ UNLOCK æŒ‰éˆ•æ¶ˆå¤±
#   4. æ—¥èªŒï¼šå®Œæ•´æ—¥èªŒ + ç°¡æ½”æ—¥èªŒ
#   5. Android åŽŸç”Ÿé€šçŸ¥ (ä¸ç”¨ Termux:API)
# ============================================================

PKG="com.mi.global.bbs"
LOGFILE="/data/local/tmp/signin_log_test.txt"
SIMPLE_LOG="/data/local/tmp/signin_simple_test.txt"

# ðŸ“ æ—¥èªŒ
log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] (æ¸¬è©¦ç‰ˆ) $MSG" | tee -a $LOGFILE
}

# ðŸ”” Android åŽŸç”Ÿé€šçŸ¥
notify() {
  MSG="$1"
  cmd notification post -S bigtext -t "å°ç±³ç°½åˆ°æ¸¬è©¦ç‰ˆ" "signin_test" "$MSG"
}

# ðŸ“Œ Tap é»žæ“Šï¼ˆç™¾åˆ†æ¯”æ›ç®—ï¼‰
SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}
HEIGHT=${SIZE#*x}
tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

# ðŸ” åˆ¤æ–·ç•«é¢æ–‡å­—
check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

# ============================================================
# ðŸš€ æ¸¬è©¦ç‰ˆç«‹å³å•Ÿå‹•ï¼ˆä¸åŠ  cronï¼Œä¸ç­‰æ™‚é–“ï¼‰
# ============================================================
log "â–¶ï¸ (æ¸¬è©¦ç‰ˆ) ç°½åˆ°æµç¨‹å•Ÿå‹•"

am force-stop $PKG
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5
log "ðŸ“± æ‰“é–‹ App å®Œæˆ"

if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "ðŸ‘‰ é»žæ“Š 'No Thanks'"
  sleep 1
fi

tap_percent 77.9 95.8
log "âœ… é»žæ“Š BTN_1"
sleep 1

tap_percent 43.1 79.6
log "âœ… é»žæ“Š BTN_2 â†’ å·²åœåœ¨ UNLOCK å‰"

# ç›´æŽ¥é»žæ“Š
for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "ðŸŽ¯ (æ¸¬è©¦ç‰ˆ) å·²å®Œæˆ 5 æ¬¡é»žæ“Š"

tap_percent 52.4 92.7
log "ðŸ›¡ï¸ (æ¸¬è©¦ç‰ˆ) è£œé»ž 1 æ¬¡"

# âœ… åˆ¤æ–·æ˜¯å¦æˆåŠŸï¼ˆä¾æ“šï¼šUNLOCK æŒ‰éˆ•æ¶ˆå¤±ï¼‰
sleep 2
if ! check_text "UNLOCK"; then
  RESULT="âœ… æˆåŠŸ"
else
  RESULT="âŒ å¤±æ•—ï¼ˆæ©˜è‰²æŒ‰éˆ•ä»å­˜åœ¨ï¼‰"
fi

log "ðŸ (æ¸¬è©¦ç‰ˆ) ç°½åˆ°å®Œæˆ â†’ $RESULT"
echo "$(date '+%Y-%m-%d') $RESULT" >> $SIMPLE_LOG
notify "$RESULT"
