#!/system/bin/sh
# ============================================================
# å°ç±³ç¤¾å€è‡ªå‹•ç°½åˆ° - Termux ç„¡ ROOT æ­£å¼ç‰ˆ
#
# ã€åŠŸèƒ½æ¸…å–®ã€‘
# 1. ç¬¬ä¸€æ¬¡åŸ·è¡Œ â†’ è‡ªå‹•å®‰è£ cron ä»»å‹™ (æ¯å¤© 23:59 åŸ·è¡Œè…³æœ¬)
# 2. æå‰åœ¨ 23:59:35 æ‰“é–‹å°ç±³ç¤¾å€ App
# 3. åˆå¤œ 00:00 è‡ªå‹•é»æ“Šç°½åˆ° (5+1 æ¬¡)
# 4. è‡ªå‹•è™•ç†ã€ŒNo Thanksã€å½ˆçª—
# 5. åˆ¤æ–·ç°½åˆ°æ˜¯å¦æˆåŠŸ (UNLOCK æŒ‰éˆ•æ˜¯å¦æ¶ˆå¤±)
# 6. ç™¼é€é€šçŸ¥ + ç´€éŒ„ log
# 7. å¦‚æœæ˜¯è…³æœ¬å–šé†’è¢å¹• â†’ ç­‰ 30 ç§’å¾Œè‡ªå‹•é—œé–‰
# ============================================================

PKG="com.mi.global.bbs"   # å°ç±³ç¤¾å€å¥—ä»¶åç¨±
LOGFILE="$HOME/signin_log.txt"  # log æª”æ¡ˆ
SCRIPT_PATH="$HOME/signin.sh"   # è…³æœ¬è‡ªèº«è·¯å¾‘

SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}
HEIGHT=${SIZE#*x}
SCREEN_OPENED_BY_SCRIPT=0

# ======== å‡½å¼å€ ========

log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $MSG" | tee -a $LOGFILE
}

tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

notify() {
  MSG="$1"
  termux-notification --title "å°ç±³ç°½åˆ°" --content "$MSG"
}

is_screen_on() {
  dumpsys power | grep -q "Display Power: state=ON"
}

turn_on_screen() {
  input keyevent KEYCODE_WAKEUP
  log "ğŸ’¡ è¢å¹•å·²é–‹å•Ÿ"
}

turn_off_screen() {
  input keyevent KEYCODE_SLEEP
  log "ğŸŒ™ è¢å¹•å·²é—œé–‰"
}

install_cron() {
  CRON_JOB="59 23 * * * sh $SCRIPT_PATH"
  crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"
  if [ $? -ne 0 ]; then
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "ğŸ•’ å·²å°‡è…³æœ¬åŠ å…¥ cron (æ¯å¤© 23:59 è‡ªå‹•åŸ·è¡Œ)"
  fi
}

# å®‰è£ cronie + å•Ÿå‹• crond
pkg install -y cronie >/dev/null 2>&1
sv-enable crond >/dev/null 2>&1
install_cron

# ======== ä¸»æµç¨‹ ========
log "â–¶ï¸ æ­£å¼ç‰ˆç°½åˆ°æµç¨‹å•Ÿå‹•"

# ç­‰åˆ° 23:59:35 æ‰ç¹¼çºŒ
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "23:59:35" ]; then
    break
  fi
  sleep 0.5
done

# ç¢ºä¿è¢å¹•äº®
if is_screen_on; then
  log "ğŸ“± è¢å¹•å·²äº® â†’ ä¿æŒç¾ç‹€"
else
  log "ğŸ“± è¢å¹•é—œé–‰ â†’ å¹«ä½ æ‰“é–‹"
  turn_on_screen
  SCREEN_OPENED_BY_SCRIPT=1
fi

# å•Ÿå‹• APP
am force-stop $PKG
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5
log "ğŸ“² App å·²å•Ÿå‹•"

# æª¢æŸ¥å½ˆçª—
if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "ğŸ‘‰ å·²é»æ“Š 'No Thanks'"
  sleep 1
fi

# é€²å…¥ç°½åˆ°é é¢
tap_percent 77.9 95.8
log "âœ… é»æ“Šé¦–é åº•éƒ¨æŒ‰éˆ• (BTN_1)"
sleep 1

tap_percent 43.1 79.6
log "âœ… é»æ“Šç°½åˆ°å…¥å£ (BTN_2)"
sleep 2

# ç­‰åˆ° 00:00:00
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:00" ]; then
    break
  fi
  sleep 0.1
done

# ç°½åˆ°é»æ“Š
for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "ğŸ¯ å·²å®Œæˆ 5 æ¬¡ç°½åˆ°é»æ“Š"

# è£œé»ä¸€æ¬¡
sleep 1
tap_percent 52.4 92.7
log "ğŸ¯ 00:00:01 è£œé» 1 æ¬¡"

# ç¢ºèªçµæœ
if check_text "UNLOCK"; then
  log "âŒ ç°½åˆ°å¤±æ•— (UNLOCK æŒ‰éˆ•ä»å­˜åœ¨)"
  notify "âŒ ç°½åˆ°å¤±æ•—"
else
  log "âœ… ç°½åˆ°æˆåŠŸ (UNLOCK æŒ‰éˆ•æ¶ˆå¤±)"
  notify "âœ… ç°½åˆ°æˆåŠŸ"
fi

# æ”¶å°¾ï¼šè¢å¹•æ§åˆ¶
if [ $SCREEN_OPENED_BY_SCRIPT -eq 1 ]; then
  log "âŒ› ç­‰å¾… 30 ç§’å¾Œè‡ªå‹•é—œè¢å¹•"
  sleep 30
  turn_off_screen
else
  log "ğŸ”† è¢å¹•åŸæœ¬æ˜¯äº®çš„ â†’ ä¸é—œé–‰"
fi

log "ğŸ æ­£å¼ç‰ˆç°½åˆ°æµç¨‹å®Œæˆ"
