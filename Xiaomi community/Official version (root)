#!/system/bin/sh
# å°ç±³ç¤¾å€è‡ªå‹•ç°½åˆ° - Root Termux ç‰ˆ (æ­£å¼ç‰ˆ)
# åŠŸèƒ½ï¼š
# 1. ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ â†’ è‡ªå‹•å®‰è£åˆ° cronï¼Œä¹‹å¾Œæ¯å¤© 23:59 è‡ªå‹•åŸ·è¡Œ
# 2. æ¯å¤© 23:59 å•Ÿå‹•ï¼Œç­‰åˆ° 00:00 é»æ“Šç°½åˆ°
# 3. æ”¯æ´ç™¾åˆ†æ¯”é»æ“Šï¼Œé©é…ä¸åŒè§£æåº¦
# 4. ç°½åˆ°å®Œæˆå¾Œåˆ¤æ–·ã€Œæ©˜è‰²æŒ‰éˆ•æ˜¯å¦æ¶ˆå¤±ã€
# 5. ç™¼é€ Android ç³»çµ±é€šçŸ¥ (ä¸ç”¨ Termux:API)

PKG="com.mi.global.bbs"
LOGFILE="/data/local/tmp/signin_log.txt"
SCRIPT_PATH="/data/local/tmp/signin.sh"

# å–å¾—è¢å¹•è§£æåº¦
SIZE=$(wm size | awk '{print $3}')
WIDTH=${SIZE%x*}
HEIGHT=${SIZE#*x}

# æ—¥èªŒå‡½å¼
log() {
  MSG="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $MSG" | tee -a $LOGFILE
}

# é»æ“Šç™¾åˆ†æ¯”åº§æ¨™
tap_percent() {
  X=$(echo "$WIDTH * $1 / 100" | bc)
  Y=$(echo "$HEIGHT * $2 / 100" | bc)
  input tap ${X%.*} ${Y%.*}
}

# åˆ¤æ–·ç•«é¢ä¸Šæ˜¯å¦å­˜åœ¨æŒ‡å®šæ–‡å­—
check_text() {
  uiautomator dump >/dev/null 2>&1
  grep -q "$1" /sdcard/window_dump.xml
}

# Android ç³»çµ±é€šçŸ¥
notify() {
  MSG="$1"
  cmd notification post -S bigtext -t "å°ç±³ç°½åˆ°" "signin_result" "$MSG"
}

# --- è‡ªå‹•å®‰è£åˆ° cron ---
install_cron() {
  CRON_JOB="59 23 * * * sh $SCRIPT_PATH"
  # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ’ç¨‹
  crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"
  if [ $? -ne 0 ]; then
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "ğŸ•’ å·²å°‡ç°½åˆ°è…³æœ¬åŠ å…¥ cronï¼Œæ¯å¤© 23:59 è‡ªå‹•åŸ·è¡Œ"
  fi
}

# å…ˆç¢ºä¿æœ‰ cron
pkg install -y cronie >/dev/null 2>&1
sv-enable crond >/dev/null 2>&1
install_cron

# --- ç°½åˆ°æµç¨‹ ---
log "â–¶ï¸ æ­£å¼ç‰ˆè‡ªå‹•ç°½åˆ°æµç¨‹å•Ÿå‹•"

# ç­‰åˆ° 23:59:35ï¼ˆææ—©æ‰“é–‹ Appï¼‰
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "23:59:35" ]; then
    break
  fi
  sleep 0.5
done

# é—œé–‰ä¸¦é‡æ–°æ‰“é–‹ App
am force-stop $PKG
sleep 1
monkey -p $PKG -c android.intent.category.LAUNCHER 1 >/dev/null 2>&1
sleep 5
log "ğŸ“± æ‰“é–‹ App å®Œæˆ"

# è™•ç† "No Thanks" å½ˆçª—
if check_text "No Thanks"; then
  tap_percent 49.0 65.1
  log "ğŸ‘‰ é»æ“Š 'No Thanks'"
  sleep 1
fi

# é€²å…¥ç°½åˆ°é 
tap_percent 77.9 95.8
log "âœ… é»æ“Š BTN_1"
sleep 1

tap_percent 43.1 79.6
log "âœ… é»æ“Š BTN_2 â†’ å·²åœåœ¨ UNLOCK å‰"
sleep 2   # ç­‰å¾… 2 ç§’ï¼Œç¢ºä¿ç•«é¢è¼‰å…¥å®Œæˆ

log "ğŸ•› ç­‰å¾… 00:00:00"

# ç­‰åˆ°åˆå¤œ
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:00" ]; then
    break
  fi
  sleep 0.1
done

# é€£é»ç°½åˆ°æŒ‰éˆ•
for i in $(seq 1 5); do
  tap_percent 52.4 92.7
  usleep 50000
done
log "ğŸ¯ 00:00:00 å·²å®Œæˆ 5 æ¬¡ç°½åˆ°é»æ“Š"

# 00:00:01 è£œé»ä¸€æ¬¡
while true; do
  NOW=$(date +%H:%M:%S)
  if [ "$NOW" = "00:00:01" ]; then
    tap_percent 52.4 92.7
    log "ğŸ›¡ï¸ 00:00:01 è£œé» 1 æ¬¡"
    break
  fi
  sleep 0.1
done

# åˆ¤æ–·æ˜¯å¦æˆåŠŸï¼ˆæ©˜è‰²æŒ‰éˆ•æ¶ˆå¤±ï¼‰
if check_text "UNLOCK"; then
  log "âŒ ç°½åˆ°å¤±æ•—ï¼Œæ©˜è‰²æŒ‰éˆ•ä»å­˜åœ¨"
  notify "âŒ ç°½åˆ°å¤±æ•—ï¼Œæ©˜è‰²æŒ‰éˆ•ä»å­˜åœ¨"
else
  log "âœ… ç°½åˆ°æˆåŠŸï¼Œæ©˜è‰²æŒ‰éˆ•å·²æ¶ˆå¤±"
  notify "âœ… ç°½åˆ°æˆåŠŸ"
fi

log "ğŸ æ­£å¼ç‰ˆç°½åˆ°æµç¨‹å®Œæˆ"
